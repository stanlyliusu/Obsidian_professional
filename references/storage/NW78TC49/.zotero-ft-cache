第 37 卷 第 5 期 2019 年 10 月

轻工机械 Light Industry Machinery

Vol． 37 No． 5 Oct． 2019

［自控·检测］

DOI： 10． 3969 / j． issn． 1005-2895． 2019． 05． 010

基于 EtherCAT 分布时钟的伺服控制系统研究

崔海彬，马钧华

（ 浙江大学 电气工程学院，浙江 杭州 310027）

摘 要： 为解决运动控制领域多轴伺服系统同步问题，提出了基于 EtherCAT 分布时钟的控制策略。研究了 EtherCAT 分

布时钟同步机制及实现过程，分析了从站在 SM 模式和 DC 模式下的中断信号误差，在 DC 模式下获得误差小于 10 ns 的

高精度同步信号。搭建了基于 LAN9252 和 AＲM 的具有同步功能的伺服控制平台； 利用 EtherCAT 从站在 DC 模式下产

生的的同步信号对位置环、速度环和电流 PWM 环的定时器进行同步，实现了伺服系统的同步算法架构。在一个二轴的

系统上进行了实验，实验结果表明系统具有较好的可靠性和实时性，能够实现从站间的精确同步。

关 键 词： 伺服控制系统； EtherCAT 总线技术； LAN9252； 分布时钟； 时钟同步

中图分类号： TP393． 11

文献标志码： A

文章编号： 1005-2895（ 2019） 05-0051-06

Ｒesearch of Servo Control System Based on Distributed Clock of EtherCAT

CUI Haibin，MA Junhua

（ College of Electrical Engineering，Zhejiang University，Hangzhou 310027，China）
Abstract： Aiming at the synchronization problem of multi-axis servo system in motion control field，a control strategy based on EtherCAT distributed clock was proposed． The EtherCAT distributed clock synchronization mechanism and its implementation process were studied． The errors of the interrupt signal in the SM mode and the DC mode were analyzed． The high-precision synchronization signal with the error less than 10 ns was obtained in the DC mode． A servo control platform based on LAN9252 and AＲM with synchronization function was built． The synchronization algorithm architecture of the servo system was realized by using the synchronization signals generated by the EtherCAT slave station in the DC mode to synchronize the timer of the position loop，the speed loop and the current PWM loop． Experimental verification was performed on a two-axis system． The experimental results show that the system has better reliability and real-time，and can achieve accurate synchronization between slave stations． Keywords： servo control system； EtherCAT； LAN9252； distributed clock； clock synchronization

在多轴伺服系统中，未同步时，各系统的时钟基准 来源于本地晶振。开机时刻的偏差以及各个伺服晶振 不同而产生的时钟漂移，会造成伺服运行节拍上的差 别，无法满足精确同步的要求。在具体应用场合中，如 报业印刷机的多轴驱动系统，要实现高精度的多轴同 步驱动。卷筒纸报业印刷机，采用多色顺序连续印刷 的方式。各个色组由独立的伺服电机驱动，要实现高 速运行时的高精度位置同步，需要采用具有同步功能 的现场总线，来实现原来需要机械长轴才能实现的同 步［1］。
德国自动化控制公司倍福（ Beckhoff） 于 2003 年

提出了基于标准以太网的 EtherCAT 总线技术。该技 术具有系统配置简单、拓扑结构灵活、传输速率高效、 实 时 性 高 且 低 成 本 的 优 势，同 时 其 分 布 式 时 钟 （ distributed clock，DC） 机制可以同步所有支持该机制 的从站时 钟，使 得 从 站 节 点 之 间 时 钟 抖 动 远 小 于 1 μs［2］。课题组针对 EtherCAT 的分布时钟机制进行分 析，并基于 LAN9252 从站控制器芯片设计二轴系统验 证 EtherCAT 同步性能。
1 EtherCAT 技术简介
EtherCAT 协议使用类型为 0x88A4 的以太网数据 帧，可以同其它类型的以太网数据帧在同一网络上进

收稿日期： 2019-01-03； 修回日期： 2019-06-06 第一作者简介： 崔海彬（ 1993） ，男，黑龙江海伦人，硕士研究生，主要研究方向为电机控制。E-mail： 18868113881@ 163． com

·52·

轻工机械 Light Industry Machinery

2019 年第 5 期

行 传 输。 一 个 EtherCAT 数 据 帧 可 以 包 含 多 个 EtherCAT 子 报 文，利 用 以 太 网 全 双 工 的 特 性， EtherCAT 数据得以进行高效交换，数据利用率达 90% 以上［3］。
EtherCAT 系统采用主从式结构，其运行原理如图 1 所示，主站根据协议创建以太网帧并将其向下发送 给各个从站。当数据帧通过一个从站节点时，从站识 别数据帧中所含命令，在数据帧中读取输出数据，并将 输 入 数 据 插 入 到 数 据 帧，同 时 修 改 工 作 计 数 器 （ working counter，WKC） 的值，用来说明该从站已处理 数据帧。然后将该数据帧传输到下一个从站，以此类 推。当数据帧流经最后一个从站后，该从站又将处理 过的数据帧向上返回，并且由第 1 个从站发送给主站。 主站接收到返回的数据帧并进行处理，比较其 中 的 WKC 值和预期 WKC 值，判断从站是否成功读写，进而 完成一次通信过程。在一个通信周期过程，从站对数 据帧的 处 理 完 全 由 硬 件 实 现，所 以 延 时 很 短，约 为 100 ～ 500 ns，这在很大程度上保证了 EtherCAT 的实时 性［4］。

求但要求不高的场合。 在 DC 模式中，通常选择主站连接的首个具有分
布时钟功能的从站作为参考从站，其时钟作为参考时 钟用来同步其它从站和主站时钟。通过主站配置同步 周期时间，可以实现所有 DC 从站同步产生 Sync0 信 号触发中断，如图 2 所示，在中断中可以进行驱动输出 或 者 输 入 锁 存 信 号，适 用 于 对 同 步 要 求 较 高 的 场 合［5］。

图 2 SM 事件中断和 Sync0 信号中断示意图 Figure 2 Schematic diagram of SM event interrupt and Sync0 signal interrupt

图 1 EtherCAT 通信原理 Figure 1 Communication principle of EtherCAT
2 EtherCAT 同步方式及实现
EtherCAT 一 共 有 3 种 同 步 方 式： 自 由 运 行 （ FreeＲun） 模式、同步管理器事件（ SM） 模式和分布时 钟（ DC） 模式。
在 FreeＲun 模式中，每个从站根据各自的定时中 断采用查询的方式来处理 EtherCAT 数据，和主站的通 信周期、其它从站的运行周期以及数据帧到达时间均 无关，主从站之间没有同步关系。
在 SM 模 式 中，当 从 站 接 收 到 主 站 发 送 的 EtherCAT 数据帧时，会产生 IＲQ 脉冲信号触发 SM 事 件中断，从站进入中断对数据帧进行处理。如图 2 所 示，在一些庞大的系统中，由于线路传输延时和从站处 理数据帧的延时，每个从站接收到数据帧的时间都是 不同的，位置越靠后的从站接收到数据帧的时间越晚， 从而无法达到精确的同步，所以该模式适合有同步要

EtherCAT 的 DC 同步算法包含 2 部分，在分布时

钟同步过程中，参考时钟与其它从站时钟在系统启动

时由于上电时间不同等原因存在一定的差值，称之为

系统时间偏移 Toffset 。EtherCAT 数据帧在线路之间传 输以及从站处理数据所需的时间，称为传输延时 Tdly。

这两者在系统初始化时主站通过发送和接收数据帧并

进行计算实现静态补偿。另外，由于各个从站使用的

晶振不同等原因，它们的时钟随时间推移存在一定差

异，称为系统时间漂移 Tdrift ，需要主站发送数据帧进行 动态补偿［6］。

在进行时钟补偿计算之前需要进行以下假设： 所

有从站处理和转发报文时间相同； 两个从站之间线路

上的传播延时相同。在 DC 同步模式中，定义每个从

站的本地时钟为 T（ i） 。当数据帧到达从站时，从站会

保存每个端口接收到数据帧前导符第 1 位的时刻。其

中，到达参考从站的时刻定义为 Trefdn，到达第 i 个从站

的时刻定 义 为 Tdown （ i） ，则 根 据 上 述 Toffset 和 Tdly 的 定

义，有以下关系：

T（ i） = Trefdn + Toffset （ i） ；

（ 1）

Tdown （ i） = Trefdn + Toffset （ i） + Tdly （ i） 。

（ 2）

［自控·检测］

崔海彬，等： 基于 EtherCAT 分布时钟的伺服控制系统研究

·53·

当数据帧流经所有从站并返回到第 i 个从站的时

刻定义为 Tup（ i） ，返回到参考从站的时刻定义为 Trefup， 同样有以下关系：

Trefup = Tup （ i） － Toffset （ i） + Tdly （ i） 。

（ 3）

根据式（ 2） 和式（ 3） ，由数据帧流经参考从站和某

一从站的 4 个时刻，可以计算出参考从站到该从站的

传输延时 Tdly ，关系如下： Tdly （ i） = ［（ Trefup － Trefdn ） － （ Tup （ i） － Tdown （ i） ） ］/2。

（ 4）

然后再由式（ 2） 可得从站 i 相对于参考时钟的系

统时间偏移 Toffset ： Toffset （ i） = Tdown （ i） － Trefdn － Tdly （ i） 。 （ 5）
参考时钟与经过补偿之后的从站时钟比较，即可

得到该从站时钟的动态漂移：

Δt = Trefdn －［T（ i） － Toffset （ i） － Tdly （ i） ］。 （ 6） 如果 Δt ＞ 0，表示本地时钟 T（ i） 比参考时钟运行

的慢，需要加快其运行，反之则需要减慢其运行，以实

现对从站时钟的动态补偿。

整个分布时钟实现过程如图 3 所示。首先，主站

采用顺序寻址方式 APＲD 遍历所有从站功能支持寄存

器，检查从站是否支持分布时钟。然后读取数据链路

层状态寄存器，检测从站的端口状态，得到 EtherCAT

网络拓扑。

图 3 EtherCAT 分布时钟实现流程图 Figure 3 Implementation flowchart of EtherCAT DC
主站采用广播写寻址方式 BWＲ 发送数据帧，在

DC 从站接收到数据帧前导符第 1 位时，将本地时钟写 入端口接收时间寄存器，并在下一个通信周期被读取。 主站根据式（ 4） 可以计算出参考从站到从站 i 的传输 延时 Tdly（ i） ，又根据式（ 5） 可以计算出从站 i 相对于参 考从站的时间偏移 Toffset （ i） ，并通过 APWＲ 寻址方式 将 Tdly （ i） 写入从站的系统时间延时寄存器，将Toffset （ i） 写入从站 的 系 统 时 间 偏 移 寄 存 器。之 后，主 站 采 用 AＲMW 寻址方式读取参考从站系统时间，并将其写入 其它所有 DC 从站的系统时间寄存器，从站时钟再根 据式（ 6） 计算时钟漂移，调整本地时钟运行速度。并 且主站不断读取从站的系统时间差值寄存器，如果小 于所设定的阈值，则将 Sync0 周期时间写入寄存器，将 Sync0 起始时间写入寄存器，并激活 Sync0 同步信号。 至此，DC 从站以设定的周期同步产生 Sync0 信号，该 信号常用作为微控制器的外部中断［7］。
3 EtherCAT 接口及硬件设计
课题测试平台采用 1 个主站和 2 个从站，使用普 通 PC 下倍福公司开发的 TwinCAT 组态软件作为主 站，从 站 协 议 控 制 器 （ ESC ） 采 用 Microchip 公 司 LAN9252 芯片，实现 EtherCAT 物理层和数据链路层通 信，从 站 微 控 制 器 采 用 ST 公 司 STM32F407ZGT6 芯 片，实现应用层。
LAN9252 芯片内部集成了 2 个以太网 PHY，每个 以太网 PHY 包含 1 个全双工 100BASE-TX 收发器且 支持 100 Mbit / s（ 100BASE-TX） 工作速率； 具有 4 kbit 双端口存储器（ DPＲAM） 、3 个现场总线存储器管理单 元（ FMMU） 和 4 个同步管理器（ SyncManager） ； 支持 16 位数字量 IO 接口、SPI 串行通信接口和 8 /16 位主机总 线接口共 3 种过程数据接口。课题组采用 16 位宽的 灵活静态存储寄存器 （ FSMC） 接 口 实 现 微 控 制 器 和 ESC 之间的数据传输。FSMC 是 STM32 系列芯片的一 种主机总线 接 口 技 术，能 够 连 接 同 步、异 步 存 储 器 和 16 位 PC 存储卡，相比传统的 SPI 接口速度更快，对应 用程序的负荷更小。整个 EtherCAT 系统框图如图 4 所示，PC 端与 ESC 采用网线连接。EEPＲOM 通过 I2C 接口与 ESC 连接，EEPＲOM 内部存放从站配置 信 息 （ ESI） ，一般为 XML 格式文件，主要包含对象字典和 过程数据映射等信息： 对象字典中包含数据的名称、类 型、长度和读写权限等信息； 过程数据映射包含数据的 输入输出配置。例如，给定转速配置类型为 INT32，只 读，输出映射。为实现主从站之间的成功通信，这些从 站配置信息需要与微控制器程序相对应。主站设备在 扫描从站时，会读取 EEPＲOM，完成对从站的初始配

·54·

轻工机械 Light Industry Machinery

置。在每个通信周期，主站向从站下发指令或读取数 据，ESC 根据时钟周期产生 Sync0 信号，该信号配置为 微控制器的外部中断信号。微控制器另外和驱动部分 连接，实现伺服驱动功能，电机采用带有位置编码器的 永磁同步电机，控制方式为矢量控制。图 5 所示为从 站部分实物。

2019 年第 5 期

图 4 EtherCAT 硬件系统框图 Figure 4 Block diagram of EtherCAT hardware system
图 5 EtherCAT 从站实验平台 Figure 5 Experimental platform of
EtherCAT slave station
4 两轴伺服系统同步设计
伺服系统电流环，位置速度环和 ADC 等进程都基 于本地的定时器，对多轴伺服系统而言，要求各控制器 的 PWM 周期相同，位置速度和电流环执行时间一致。 因为各独立系统的定时器的运行频率相对于 DC 或快 或慢，会使得关键进程的中断无法同步，所以不同微控 制器的本地定时器的同步尤为重要。基于搭建的硬件 平台，课题组在 2 个独立的伺服控制系统中引入 Sync0 信号，实现伺服系统时钟的同步。其同步机制时序图 如图 6 所示。

图 6 伺服轴定时器同步示意 Figure 6 Synchronization of servo axis timer 系统初始化过后，在首个 Sync0 信号到来时，清零 系统的定时器，消除开机同步误差。Sync0 信号周期 设置为 PWM 周期的整数倍，如 10 倍。这样当后续的 Sync0 信号到来时，继续将 2 个伺服 轴 定 时 器 清 零。 由于该时刻两定时器计数值都接近于 0 且误差很小， 这种方案可以在不扰乱定时器周期中断的情况下，消 除时钟漂移。另外，在后续 Sync0 信号到来时，执行位 置速度环计算，以同步两伺服轴位置速度环执行时间。 本课题中，2 个伺服系统具有相同的软件结构，高 级定时器 TIM8 采用增减计数模式，输出中心对齐的 PWM 波形，综合 IGBT 的开关损耗和电流控制精度和 噪声，PWM 频 率 选 择 为 10 kHz。DC 周 期 设 置 为 1 ms，即一个 Sync0 信号周期包含 10 个 PWM 周期。电 流环的时间常数较小，电流 PID 调节的控制周期，与 PWM 同频，为 10 kHz； 而位置速度闭环，是机械时间常 数，大于电气的时间常数。可按 PWM 频率 10 倍分频 来进行位置和速度的 PID 控制，即位置速度环执行频 率为 1 kHz。 利 用 一 个 周 期 为 10 的 软 件 计 数 器 Counter 对 TIM8 的中断次数计数，当其为 0 时进行位 置和速度环计算。 系统主要中断程序流程图如图 7 所示，包含 Sync0 外部中断和 TIM8 周期中断。TIM8 周期中断作为三闭 环执行的时间基准，是伺服控制的基本控制中断，每次 进入该中断，判断中断次数计数器 Counter 为 0 时执行 位置速度环计算，然后递增 Counter，当 Counter 值为 10 时将其清零，电流环则每次中断都计算。Sync0 中断 实现各个从站间的同步，Sync0 信号到来时各从站同 步进入中断，首先，将定时器计数器 TIM8 _CNT 清零， 对系 统 时 钟 进 行 动 态 补 偿； 其 次，对 Counter 进 行 清 零，这样在下一个 TIM8 周期中断中判断 Counter 为 0 即执行位置速度环计算，实现了各伺服轴之间位置速 度环执行的同步； 最后，微控制器在用户程序中进行 EtherCAT 数据交换，将给定位置等信息赋值给控制程

［自控·检测］

崔海彬，等： 基于 EtherCAT 分布时钟的伺服控制系统研究

·55·

序参数，并采样上传实际位置等本地数据。Sync0 中 断通过清零 TIM8 定时器 TIM8_CNT 和中断次数计数 器 Counter，传递同步信号到 TIM8 的中断同步，实现了 3 个闭环的完全同步。另外，当 ESC 正常发送 Sync0 信号到微控制器时，该算法实现了从站间的同步； 若 Sync0 信 号 丢 失，各 伺 服 轴 则 按 非 同 步 的 单 轴 模 式 运行。

图 8 SM 同步模式下 IＲQ 信号波形 Figure 8 IＲQ signal waveform in SM synchronous mode
再配置 2 个从站运行在 DC 同步模式，同步信号 频率为 1 kHz。用示波器采集 Sync0 信号波形，结果如 图 9 所示。经多次测量二者的差值在 ± 10 ns 以内。

图 7 伺服系统中断程序流程 Figure 7 Interrupt routine flowchart of servo system
5 实验及数据分析
通过 TwinCAT 软件配置 2 个从站的运行模式为 SM 同步模式，主从站通信频率配置为 1 kHz。用示波 器采集 IＲQ 信号波形，结果如图 8 所示，通道 CH1 为 从站 1 输出波形，CH2 为从站 2 输出波形。经多次试 验得出从站 2 的 IＲQ 信号滞后从站 1 约 750 ns。

图 9 DC 同步模式下 Sync0 信号波形 Figure 9 Sync0 signal waveform in DC synchronous mode
在程序主循环中，采用 DAC 将 TIM8 计数器的实 时值输出，示波器捕获 2 个系统的 DAC 输出在未同步 时结果及同步后的 DAC 输出结果如图 10 所示。并捕

·56·

轻工机械 Light Industry Machinery

获 Sync0 信号和同步后的其中一个系统的 DAC 输出， 其波形图如图 11 所示。

2019 年第 5 期

图 10 两系统的 DAC 输出波形 Figure 10 DAC output waveform of two system

图 11 系统的 DAC 输出与 Sync0 信号波形图 Figure 11 Waveform of DAC output and Sync0 signal
6 结论
课 题 组 介 绍 了 EtherCAT 原 理，着 重 分 析 了 EtherCAT 分 布 时 钟 同 步 机 制，并 设 计 搭 建 了 基 于 EtherCAT 分布时钟的伺服控制系统。设计了算法流 程，实现了同步信号 Sync0 到伺服环的同步。经过实 验验证，EtherCAT 具有较好的可靠性和实时性，能够 实现从站间的精确同步。 参考文献：
［1］ 周炎涛，张舜，黄庆，等． 基于 EtherCAT 多轴伺服运动控制系统的 同步性能研究［J］． 科技导报，2012，30（ 增刊 1） ： 56．
［2］ 陈灏，宋宝，唐小琦． EtherCAT 精确时钟同步技术的实现［J］． 组 合机床与自动化加工技术，2014（ 5） ： 69．
［3］ 阮倩茹，王辉，施大发，等． 基于 EtherCAT 的高性能交流伺服控制 系统设计［J］． 科技导报，2010，28（ 20） ： 59．
［4］ 左振领，何方，李霄． 基于 STM32 的 EtherCAT 从站的设计与实现 ［J］． 组合机床与自动化加工技术，2016（ 7） ： 1 － 3．
［5］ 党选举，刘亚平，姜辉，等． EtherCAT 从站设计及精确时钟同步技 术研究［J］． 测控技术，2017，36（ 2） ： 101．
［6］ 俞士磊，樊留群，夏斌，等． EtherCAT 时钟同步技术的研究与应用 ［J］． 制造业自动化，2013，35（ 12） ： 119．
［7］ 刘辉，林威，王培盛，等． EtherCAT 时钟同步技术研究［J］． 计算机 测量与控制，2014，22（ 11） ： 3776．

櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂櫂

［信息·简讯］

·行业简讯·

西门子 MindSphere 生态系统在华初具规模

西门子在今年 7 月 26 日举办的 MindSphere 合作伙伴峰会北京站上与 11 家企业签署合作协议，共同打造以 MindSphere 为核心 平台的工业物联网生态系统，以满足更多中国工业企业在数字化转型过程中的不同需求。
“自 MindSphere 落地中国市场以来，西门子不断加大投入，致力于打造一个生长于中国市场、服务于中国市场，包含终端用户、 OEM 以及 APP 开发者的工业物联网生态系统。”西门子（ 中国） 有限公司执行副总裁、西门子大中华区数字化工业集团总经理王海 滨表示，“西门子在数字化领域的先进技术和行业专长以及 MindSphere 开放的平台前景为合作伙伴注入了信心。我们期待更多合 作伙伴的加入，共同赋能中国工业的数字化转型。”
在此次峰会上，西门子还向现场近 100 家潜在行业合作伙伴和客户介绍了即将在中国市场发布的 MindSphere 合作伙伴计划。 利用 MindSphere，企业能够以可持续和经济的方式实现资产管理和数据管理，以适合自己的便捷的数字化工具，加速数字化转型进程。
（ 张 争）

